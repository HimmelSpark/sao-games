<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover, user-scalable=no">
<title>Кроссворд САО — мини-приложение</title>
<script src="https://telegram.org/js/telegram-web-app.js"></script>
<style>
  :root{
    --bg:#faf7f5; --ink:#222; --muted:#8a8a8a; --accent:#b8002f;
    --ok:#1a7f37; --warn:#b3261e; --tile:#ffffff; --tileBorder:#d6d6d6; --keyBg:#ffe6ea;
    --radius:14px; --gap:6px;
    /* мобильная клетка: масштабируется по ширине экрана */
    --cell: clamp(34px, 8.2vw, 44px);
    --vh: 1vh; /* фикс для мобильного 100vh */
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0; background:var(--bg); color:var(--ink);
    font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
    line-height:1.35; -webkit-text-size-adjust:100%;
    padding: env(safe-area-inset-top) env(safe-area-inset-right) env(safe-area-inset-bottom) env(safe-area-inset-left);
    overscroll-behavior: none;
  }
  header{ padding:16px 14px 6px }
  h1{ margin:0; font-size:clamp(18px,5.2vw,26px) }
  .sub{ color:var(--muted); margin-top:4px; font-size:13px }
  main{
    display:grid; grid-template-columns:1fr; gap:12px; padding:8px 12px 16px;
    min-height: calc(var(--vh) * 100 - 80px);
  }
  .boardWrap{
    background:var(--tile); border:1px solid var(--tileBorder); border-radius:var(--radius);
    padding:10px; box-shadow: 0 6px 18px rgba(0,0,0,.04);
  }
  .board{
    display:grid; gap: var(--gap); justify-content:center; padding:6px; overflow:auto;
    -webkit-overflow-scrolling: touch;
  }
  .cell{
    position:relative; width: var(--cell); height: var(--cell);
    border-radius:10px; box-shadow: inset 0 0 0 1px var(--tileBorder); background:#f1f1f1;
    touch-action: manipulation;
  }
  .cell.input{ background:var(--tile) }
  .cell.key{ background:var(--keyBg) }
  .cell input{
    width:100%; height:100%; background:transparent; border:0; outline:none;
    font-size:18px; font-weight:800; text-align:center; text-transform:uppercase; color:var(--ink);
    caret-color: var(--accent);
  }
  .cell.bad input{ color:var(--warn) }
  .cell.good input{ color:var(--ok) }
  .num{ position:absolute; top:3px; left:5px; font-size:11px; color:var(--muted); user-select:none; pointer-events:none }
  .legend{
    background:var(--tile); border:1px solid var(--tileBorder); border-radius:var(--radius);
    padding:12px; box-shadow: 0 6px 18px rgba(0,0,0,.04);
  }
  details{ border-radius:12px; border:1px dashed #d9d9d9; padding:8px 10px; margin-bottom:8px; background:#fff }
  summary{ cursor:pointer; font-weight:700; font-size:14px }
  .clue{ margin:6px 0 10px; padding-left:4px; font-size:13px }
  .clue b{ color: var(--accent) }
  .toolbar{ display:flex; gap:8px; flex-wrap:wrap; padding:6px 0 0 2px }
  button{
    appearance:none; border-radius:10px; border:1px solid var(--tileBorder);
    padding:10px 12px; background:#fff; cursor:pointer; font-weight:700; font-size:14px;
  }
  button.primary{ background:var(--accent); color:#fff; border-color:transparent }
  .status{ margin-top:8px; font-weight:700; font-size:14px }
  .status.ok{ color:var(--ok) } .status.warn{ color:var(--warn) }
  .keyWord{ display:flex; gap:var(--gap); align-items:center; justify-content:center; margin:10px 0 2px; flex-wrap:wrap }
  .keyTile{
    width:var(--cell); height:var(--cell); border-radius:10px; background:var(--keyBg);
    box-shadow: inset 0 0 0 1px var(--tileBorder); display:grid; place-items:center; font-weight:900; font-size:18px;
  }
  .credits{ text-align:center; color:var(--muted); font-size:11px; margin-top:4px }
  /* компактная легенда на телефоне */
  @media (max-width: 820px){ details:not(:first-of-type){ margin-bottom:6px } }
</style>
</head>
<body>
<header>
  <h1>Кроссворд про САО</h1>
  <div class="sub">Заполни 9 горизонталей, собери ключевое слово по выделенной колонке.</div>
</header>

<main>
  <section class="boardWrap">
    <div id="board" class="board" role="grid" aria-label="Поле кроссворда"></div>
    <div class="keyWord" aria-live="polite" id="keyWord"></div>
    <div class="toolbar">
      <button class="primary" id="checkBtn">Проверить</button>
      <button id="revealBtn">Открыть правильные</button>
      <button id="resetBtn">Сбросить</button>
    </div>
    <div id="status" class="status" aria-live="polite"></div>
    <div class="credits">Сентябрь 2025 • САО • мини-приложение Telegram</div>
  </section>

  <aside class="legend">
    <h3 style="margin:0 0 6px;font-size:16px">Подсказки</h3>
    <details open><summary>1) Горизонталь</summary><div class="clue"><b>ДИНАМО.</b> Где в воротах жил Лев Яшин, а рядом зелёная ветка уводит в центр из тени путевого дворца.</div></details>
    <details open><summary>2) Горизонталь</summary><div class="clue"><b>МОЛЖАНИНОВСКИЙ.</b> Самый северный район: тут самолёты ближе, чем метро, а граница с областью — почти за калиткой.</div></details>
    <details open><summary>3) Горизонталь</summary><div class="clue"><b>ТИМИРЯЗЕВСКИЙ.</b> Район опытных полей и дендрарийных троп, где будущие агрономы изучают почву под боком у магистралей.</div></details>
    <details open><summary>4) Горизонталь</summary><div class="clue"><b>ПЕТРОВСКИЙ ПАРК.</b> Аллеи между красным путевым дворцом и шумом большой арены: прогулка — и уже слышно футбол.</div></details>
    <details open><summary>5) Горизонталь</summary><div class="clue"><b>РЕЧНОЙ ВОКЗАЛ.</b> «Порт пяти морей» со шпилем и звёздой: отсюда водные путешествия начинаются прямо из САО.</div></details>
    <details open><summary>6) Горизонталь</summary><div class="clue"><b>КОПТЕВО.</b> Название с ароматом дымка: когда-то тут коптили и смолили, теперь звучит на МЦК и картах района.</div></details>
    <details open><summary>7) Горизонталь</summary><div class="clue"><b>ВОЙКОВСКАЯ.</b> Станция с спорным именем у «Метрополиса», зелёная линия между ветром «Сокола» и водой «Водного».</div></details>
    <details open><summary>8) Горизонталь</summary><div class="clue"><b>КРАСНЫЙ БАЛТИЕЦ.</b> Платформа-ветеран и ДК в одном топониме: на диаметре — как на электричке, но по-городски.</div></details>
    <details open><summary>9) Горизонталь</summary><div class="clue"><b>АЭРОПОРТ.</b> В небо здесь больше не взлетают, но память о Ходынском поле живёт в названии района и станции.</div></details>
    <hr style="margin:10px 0">
    <div style="font-size:13px;color:#666">Ключ — буквы из выделенной вертикали.</div>
  </aside>
</main>

<script>
(function(){
  // --- Telegram Mini App glue ---
  const tg = window.Telegram?.WebApp;
  const isTG = !!tg;
  if (isTG) {
    // применяем тему клиента
    applyThemeFromTelegram(tg.themeParams || {});
    tg.setHeaderColor('secondary_bg_color');
    tg.setBackgroundColor('bg_color');
    tg.expand(); // на мобиле сразу разворачиваем
    tg.ready();

    // нижняя MainButton = "Проверить"
    tg.MainButton.setText('Проверить').show();
    tg.onEvent('mainButtonClicked', () => document.getElementById('checkBtn').click());

    // BackButton = "Сбросить"
    tg.BackButton.show();
    tg.onEvent('backButtonClicked', () => document.getElementById('resetBtn').click());
  }

  // фикс 100vh на мобилках
  const setVh = () => {
    document.documentElement.style.setProperty('--vh', (window.innerHeight * 0.01) + 'px');
  };
  setVh(); addEventListener('resize', setVh);

  function applyThemeFromTelegram(tp){
    // Telegram передаёт цвета, если есть — используем
    const set = (v, def) => v || def;
    const root = document.documentElement.style;
    root.setProperty('--bg', set(tp.bg_color, getComputedStyle(document.documentElement).getPropertyValue('--bg')));
    root.setProperty('--ink', set(tp.text_color, '#222'));
    root.setProperty('--tile', set(tp.secondary_bg_color, '#fff'));
    root.setProperty('--tileBorder', set(tp.section_separator_color, '#d6d6d6'));
    root.setProperty('--accent', set(tp.button_color, '#b8002f'));
    // под ключевую вертикаль оставим розовый фон, но можно и из темы
  }

  // --- Crossword data ---
  const KEY_COL = 10;
  const entries = [
    { n:1, word:"ДИНАМО", keyIndex:0, row:1 },
    { n:2, word:"МОЛЖАНИНОВСКИЙ", keyIndex:0, row:2 },
    { n:3, word:"ТИМИРЯЗЕВСКИЙ", keyIndex:1, row:3 },
    { n:4, word:"ПЕТРОВСКИЙПАРК", keyIndex:2, row:4 },
    { n:5, word:"РЕЧНОЙВОКЗАЛ", keyIndex:0, row:5 },
    { n:6, word:"КОПТЕВО", keyIndex:1, row:6 },
    { n:7, word:"ВОЙКОВСКАЯ", keyIndex:0, row:7 },
    { n:8, word:"КРАСНЫЙБАЛТИЕЦ", keyIndex:0, row:8 },
    { n:9, word:"АЭРОПОРТ", keyIndex:0, row:9 },
  ];
  const KEY_TARGET = "ДМИТРОВКА";

  const up = s => (s||"").toUpperCase().replace('ѐ','Е');
  const onlyLetter = c => /[А-ЯЁ]/i.test(c);

  const board = document.getElementById("board");
  const keyWrap = document.getElementById("keyWord");
  const statusEl = document.getElementById("status");

  // вычисляем ширину сетки
  const maxRight = Math.max(...entries.map(e => (KEY_COL + (e.word.length - e.keyIndex - 1))));
  const totalCols = Math.max(24, maxRight + 1);
  board.style.gridTemplateColumns = `repeat(${totalCols}, var(--cell))`;

  // плитки для ключа
  const keyTiles = [];
  for (let i=0; i<entries.length; i++){
    const t = document.createElement("div");
    t.className = "keyTile";
    t.setAttribute("aria-label", `Буква ключа ${i+1}`);
    keyWrap.appendChild(t);
    keyTiles.push(t);
  }

  // поля ввода
  const inputsByRow = new Map();
  entries.forEach(e => {
    const startCol = KEY_COL - e.keyIndex;
    const row = e.row;
    const word = up(e.word);
    if(!inputsByRow.has(row)) inputsByRow.set(row, []);
    for (let i=0; i<word.length; i++){
      const col = startCol + i;
      const cell = document.createElement("div");
      cell.className = "cell input" + (col === KEY_COL ? " key" : "");
      cell.style.gridColumn = col;
      cell.style.gridRow = row;

      const input = document.createElement("input");
      input.maxLength = 1;
      input.inputMode = "latin"; // без всплытия цифровой клавы
      input.autocomplete = "off";
      input.spellcheck = false;
      input.dataset.expected = word[i];
      input.dataset.partOf = row;
      input.dataset.index = i;
      cell.appendChild(input);

      if (i === 0){
        const num = document.createElement("div");
        num.className = "num";
        num.textContent = e.n;
        cell.appendChild(num);
      }

      board.appendChild(cell);
      inputsByRow.get(row).push(input);
    }
  });

  function updateKeyTiles(){
    entries.forEach((e, i) => {
      const arr = inputsByRow.get(e.row);
      const keyInput = arr[e.keyIndex];
      keyTiles[i].textContent = up(keyInput.value || "");
    });
  }

  function focusNext(row, idx, dir=+1){
    const arr = inputsByRow.get(row);
    const next = arr[idx+dir];
    if(next) next.focus();
  }

  board.addEventListener("input", (ev)=>{
    const el = ev.target;
    if (el.tagName !== "INPUT") return;
    const v = up(el.value).trim();
    if (v && onlyLetter(v)){
      el.value = v;
      const idx = +el.dataset.index;
      const row = +el.dataset.partOf;
      focusNext(row, idx, +1);
      if (isTG) tg.HapticFeedback?.impactOccurred("light");
    } else { el.value = ""; }
    updateKeyTiles();
  });

  board.addEventListener("keydown", (ev)=>{
    const el = ev.target;
    if (el.tagName !== "INPUT") return;
    const idx = +el.dataset.index;
    const row = +el.dataset.partOf;
    if (ev.key === "ArrowRight"){ ev.preventDefault(); focusNext(row, idx, +1); }
    if (ev.key === "ArrowLeft"){ ev.preventDefault(); focusNext(row, idx, -1); }
    if (ev.key === "Backspace" && !el.value){ ev.preventDefault(); focusNext(row, idx, -1); }
  });

  function setStatus(msg, ok=false){
    statusEl.textContent = msg;
    statusEl.className = "status " + (msg ? (ok ? "ok" : "warn") : "");
  }

  function check(correctOnly=false){
    let allGood = true;
    entries.forEach(e => {
      const arr = inputsByRow.get(e.row);
      let rowOk = true;
      arr.forEach(inp => {
        const expected = up(inp.dataset.expected);
        const got = up(inp.value);
        const cell = inp.parentElement;
        cell.classList.remove("bad","good");
        if (got === expected){
          if(!correctOnly) cell.classList.add("good");
        } else {
          rowOk = false;
          if(!correctOnly) cell.classList.add("bad");
        }
      });
      if (correctOnly && !rowOk){ arr.forEach(inp => { inp.value = up(inp.dataset.expected); }); }
      allGood = allGood && rowOk;
    });
    updateKeyTiles();
    return allGood;
  }

  function confetti(){
    const N = 80;
    for (let i=0;i<N;i++){
      const p = document.createElement("div");
      p.style.position="fixed"; p.style.width="8px"; p.style.height="8px";
      p.style.left = (Math.random()*100)+"vw"; p.style.top = "-12px";
      p.style.background = `hsl(${Math.random()*360}, 90%, 55%)`;
      p.style.opacity = "0.9"; p.style.borderRadius = "2px";
      p.style.transform = `rotate(${Math.random()*360}deg)`;
      p.style.transition = "transform 1.2s linear, top 1.2s ease-in";
      p.style.zIndex = "9999";
      document.body.appendChild(p);
      setTimeout(()=>{ p.style.top = "110vh"; p.style.transform = `translateY(0) rotate(${Math.random()*360}deg)`; }, 30 + Math.random()*150);
      setTimeout(()=>p.remove(), 1600);
    }
  }

  function resetBoard(){
    document.querySelectorAll(".cell").forEach(c=>c.classList.remove("good","bad"));
    document.querySelectorAll("input").forEach(i=>i.value="");
    updateKeyTiles(); setStatus("");
    const first = document.querySelector("input"); if(first) first.focus();
  }

  // кнопки
  document.getElementById("checkBtn").addEventListener("click", ()=>{
    const ok = check(false);
    const currentKey = keyTiles.map(t=>t.textContent||"_").join("");
    if (ok){
      if (currentKey === KEY_TARGET){
        confetti();
        setStatus(`Браво! Ключевое слово: ${KEY_TARGET}`, true);
        if (isTG) tg.HapticFeedback?.notificationOccurred("success");
        // можно отправить результат боту (клавиатурный сценарий)
        try{ isTG && tg.sendData(JSON.stringify({key: currentKey, ok: true})); }catch(e){}
      } else {
        setStatus(`Все строки верны. Ключевое слово: ${currentKey}`, true);
      }
    } else {
      setStatus("Есть ошибки. Неверные клетки подсвечены.");
      if (isTG) tg.HapticFeedback?.impactOccurred("medium");
    }
  });
  document.getElementById("revealBtn").addEventListener("click", ()=>{
    check(true);
    const currentKey = keyTiles.map(t=>t.textContent||"_").join("");
    if (currentKey === KEY_TARGET){
      confetti(); setStatus(`Готово! Ключевое слово: ${KEY_TARGET}`, true);
      if (isTG) tg.HapticFeedback?.notificationOccurred("success");
    } else { setStatus("Правильные буквы подставлены."); }
  });
  document.getElementById("resetBtn").addEventListener("click", resetBoard);

  // построение сетки после кнопок
  updateKeyTiles(); resetBoard();

  // grid columns после вычислений
  // переносим сюда для стабильности макета
  const maxRight2 = Math.max(...entries.map(e => (KEY_COL + (e.word.length - e.keyIndex - 1))));
  board.style.gridTemplateColumns = `repeat(${Math.max(24, maxRight2 + 1)}, var(--cell))`;
})();
</script>
</body>
</html>
